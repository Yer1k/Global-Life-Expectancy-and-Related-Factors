---
title: "Analysis of Global Life Expectancy and Related Factors"
author: "Echo Chen, Andrew Kroening, Pooja Kabber, Dingkun Yang"
date: "December 2nd, 2022"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
bibliography: citations.bib
link-citation: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

```{r load_libraries, echo=FALSE, message=FALSE, header=FALSE, warning=FALSE}
packages <- (c("table1", "ggplot2", "xtable", "pander","ggcorrplot", "tidyverse", "stargazer", "ggfortify", "caTools", "car", "corrplot", "gridExtra", "leaps", "Metrics", "reshape2", "moments", "mice", "cowplot", "caret", "AICcmodavg", "GGally", "pROC", "arm"))
# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}
# Packages loading
invisible(lapply(packages, library, character.only = TRUE))
```

```{r read_data, echo=FALSE, message=FALSE, warning=FALSE}
df_life_expectancy <- read.csv(file = '../Datasets/Life_Expectancy_Data.csv')
df_life_expectancy <- data.frame(df_life_expectancy)
df_life_expectancy$Status <- factor(df_life_expectancy$Status)
df_life_expectancy$Year <- as.factor(df_life_expectancy$Year)
df_life_expectancy$Country <- as.factor(df_life_expectancy$Country)

df_life_expectancy_2014 <- df_life_expectancy[df_life_expectancy$Year == 2014, ]

# Splits for Q2

# Training
df_life_expectancy_2014$Status_num <- rep(0,nrow(df_life_expectancy_2014))
df_life_expectancy_2014$Status_num[df_life_expectancy_2014$Status=="Developed"] <- 1
df_life_expectancy_2014_cleaned <- na.omit(df_life_expectancy_2014)
df_life_expectancy_2014_cleaned$Income.composition.of.resources <- df_life_expectancy_2014_cleaned$Income.composition.of.resources * 100 
# FOR BETTER INTERPERTATION (IT RANGES FROM 0 TO 1), After transformation, one unit would be 1 percent***
# ended up getting rid of this anyway

# Testing 
df_life_expectancy_2013 <- df_life_expectancy[df_life_expectancy$Year == 2013, ]
df_life_expectancy_2013$Status_num <- rep(0,nrow(df_life_expectancy_2013))
df_life_expectancy_2013$Status_num[df_life_expectancy_2013$Status=="Developed"] <- 1
df_2013_cleaned <- na.omit(df_life_expectancy_2013)
df_2013_cleaned$Income.composition.of.resources <- df_2013_cleaned$Income.composition.of.resources * 100 
```

```{r ingest, echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
df_pop <- read_csv(file = '../Datasets/pop.csv', skip = 4)
df_pop_2014 <- df_pop[,c("Country", "2014")]
df_2014 <- merge(df_life_expectancy_2014, df_pop_2014, by = "Country")
df_2014_cleaned <- na.omit(df_2014)
names(df_2014_cleaned)[names(df_2014_cleaned)=="2014"] <- "pop"

# Testing 
df_pop_2013 <- df_pop[,c("Country", "2013")]
df_2013 <- merge(df_life_expectancy_2013, df_pop_2013, by = "Country")
# df_2013$pop_10k <- df_2013$Population * 10000  
# df_2013$pop_diff <- df_2013$pop_10k - df_2014$pop
df_2013_cleaned <- na.omit(df_2013)
names(df_2013_cleaned)[names(df_2013_cleaned)=="2013"] <- "pop"

```

-----
# Abstract 

This analysis seeks to understand which factors influence life expectancy and the development status of countries worldwide. The dataset used for this research consisted of national disease, economic, and social factors for 2013 and 2014. The primary source is the World Health Organization (WHO), with data augmented from the World Bank where necessary. We consider two research questions in the analysis: one prediction and one inference question. Unique models are fit for each problem, and the results are analyzed for a utility to policymakers. We find that investments in education pay great dividends to overall social well-being, with a significant upside in both questions. Public health investments also carry positive upsides, although the effect is consistent with expectations.

\newpage
# Introduction

Life expectancy averages are increasing worldwide and have been for some time. The specific drivers of this newfound human longevity are the topic of much debate in academic and policy circles. Despite differing motivations, both groups seek to understand and find insights to improve population well-being. While some obvious indicators and areas for improvement would pay high dividends, this analysis aims to find high-payoff factors that reach beyond the economic aspects that recent studies have popularized.

This analysis uses data from the WHO and World Bank. We seek to understand the variables that most influence societal well-being. From the two research questions, we aim to improve insights into factors that drive a country's developmental status and the population health indicators that lead to improved life expectancy. Below are the questions we aim to answer in this analysis:

## Research Questions 

**Question #1 (Prediction)**

*"How did major disease, economic, and social factors impact life expectancy around the globe in 2014?"*

**Question #2 (Inference)**

*"How did disease and mortality rates, along with national economic factors, contribute to a country's development status in 2014?"*

## Data

The dataset [@rajarshi_2018] for this analysis contains national-level observations of variables related to life expectancy around the globe for a period spanning the early portion of the 21st century. The complete dataset includes observations beginning in the year 2000 and ending in the year 2015. As a full dataset, there are 2,938 observations for 22 variables. Practically, each country has approximately one observation each year, averaging 183 for each of the 16 years encompassed by the data. The dataset effectively contains 20 variables for each country and year combination, covering significant disease, economic, and social factors. 

During the initial round of exploratory data analysis (EDA), the team identified many missing values from the dataset. These missing values included: 41x Population, 10x Hepatitis B, and 10x Schooling observations, with a large number of missing population values being the most concerning. The team considered several approaches for mitigating the problems posed by this data, as it precludes several potentially influential countries from being included in this analysis. We considered multiple imputation and scholastic imputation for mitigating these issues but ultimately decided against both approaches.

An alternative approach for missing data was identified as theoretically feasible early in the analysis. Because of the national level of our dataset, we could find suitable replacement values from another source with high integrity in these areas, such as the World Bank, the International Monetary Fund, or the CIA World Factbook. While those sources had existing data for some of our missing values, we opted not to use them for replacement. Most replacement candidates we found did not match the surrounding data points (i.e., GDP figures for the country/year in question needed to be closer to consider a match). Thus we have low confidence that those values would be consistent with the WHO's data collection methods. While options are certainly available, the team assesses that the potential gain from including the additional countries does not offset the possible bias or skew introduced by imputation.

As for population variable, we find problems in the consistency of the value unit. We identify that some countries' population are pre-processed to be in 10,000s, while others are recorded in actual number. We decided to substitute this variable with reliable data source, World Bank [@world]. After the initial treatments to factor variables, we reduce our dataset to complete cases only and subset for our analysis's two years of interest. After these steps and decisions, we subset the data to make two sub-datasets: one for 2014 and one for 2013, which we will use in our second research question. These two datasets are nearly identical in size, with the 2014 dataset consisting of 129 observations and the 2013 dataset having 128 without any missingness.

# Methods

To analyze this data and accomplish the research objectives, the team began with an *a priori* variable selection. We then checked certain variables for multicollinearity, after which we conducted EDA to examine the distributions of key variables. We conducted these steps to prepare our data and methods for fitting and assessing the models used to answer both questions. 

## *A Priori* variable selection

To answer both research questions, we began by pre-selecting variables that the team believed would be the most impactful and insightful to analyze. When investigating the factors that influence life expectancy, we chose to include the following:

* Country development status.
* Population.
* Measles incidence.
* Polio immunization coverage.
* HIV/AIDS deaths among children.
* Gross domestic product (GDP).
* Income composition of resources.
* Average body mass index (BMI).
* Government expenditure on healthcare (% total expenditure).
* Government expenditure on healthcare (% GDP).
* Average years of schooling.

The second question selected slightly different variables. We will attempt to answer the second question, whether a country is developed or developing, by this set of variables: 

* Life expectancy. 
* Average BMI.
* HIV/AIDS deaths among children.
* Average years of schooling.
* Population.
* Income composition of resources.
* GDP.
* Government expenditure on healthcare (% GDP). 

We assess that these variables provide coverage of the broad range of economic, social, and health factors included in our data and will be insightful when fit to a model.

```{r handling_missing_data, echo=FALSE, message=FALSE, warning=FALSE}

# complete case analysis - 183 to 131 rows
df_life_expectancy_cc_2014 <- df_life_expectancy_2014[complete.cases(df_life_expectancy_2014),]
df_life_expectancy_2014 <- df_life_expectancy_cc_2014

# stochastic imputation

# multiple imputation
```

## Correlation and Multicollinearity

While conducting EDA, we found that a few variables in our dataset were potentially correlated. To determine the actual effect, we investigated the most significant relationships. We used a correlation matrix plot and a VIF function to analyze the correlations. We found that these variables were highly correlated:

* Infant deaths and deaths under age five
* Government expenditure on healthcare (% GDP) and GDP
* Hepatitis B immunizations and Diphtheria immunizations
* Thinness variables (measuring starvation in different age groups)
* Schooling and income composition of resources

Since percentage expenditure is highly correlated with GDP and schooling is highly correlated with income composition of resources, we dropped percentage expenditure and schooling from our initial list of *a priori* variables.

```{r correlation_check, echo=FALSE, fig.height=5, message=FALSE, warning=FALSE}
df_life_expectancy_2014 <- df_2014_cleaned
df_life_expectancy_2014_cor <- subset(df_life_expectancy_2014, select = -c(Country, Status, Year, Status_num))

# TODO: put the correlation plot in appendix
# TODO: include VIF table, if too big, put in appendix
# corrplot(cor(df_life_expectancy_2014_cor), method = "color")

# mod.linear <- lm(Life.expectancy ~ ., data = subset(df_life_expectancy_2014_cor))
# vifs <- data.frame(vif(mod.linear))
# ggplot(vifs, aes(y=vif.mod.linear., x=row.names(vifs))) +
#   geom_bar(aes(fill=vif.mod.linear.<5),stat="identity")+
#   scale_y_continuous(trans = "sqrt",  breaks = c(5, 10, 50, 100))+
#   geom_hline(yintercept = 5, colour = "red") +
#   ggtitle("VIF per feature") +
#   xlab("Featurs") + ylab("VIF") +
#   theme(axis.text.x=element_text(angle=20, hjust=1))+
#   theme(text = element_text(size = 18))+
#   scale_fill_brewer(palette="Dark2")

# infant deaths, under five deaths
# percentage expenditure, GDP
# Hepatitis B, Diphtheria
# thinness variables
# schooling, income composition of resources

# after checking for collinearity, removed schooling and percentage expenditure

# apriori variables
# Status + Population + Life.expectancy + Measles + Polio + HIV.AIDS + GDP + Income.composition.of.resources + BMI + Total.expenditure
```

## Exploratory Data Analysis

The dataset for our analysis has 22 variables, as previously described. For a complete description of all variables, see Appendix A. The categorical and outcome variable for our second question is country development status. We check the relationship between this variable and the outcome variable for our first question, life expectancy. We use boxplots to find that the life expectancy in developed countries is higher, which means the categorical variable might be a good predictor for the model in the first question. Another interesting observation that is useful in understanding the factors that affect development status of a country is the boxplot of GDP vs Status. We see that the median GDP is higher for developed countries. We also see from the Schooling vs Status plot that the median years of schooling is larger for developed countries than for developing countries. The full summary of EDA plots is available in Appendix B.

For the continuous variables, we selected the a priori variables we had selected earlier and examined those relationships. First, we examined the schooling, income, thinness, GDP, and HIV variables and found linear relationships consistent with the initial prediction of the variables of interest. After we dropped correlated pairs showing significantly high VIFs, we were left with the resulting dataset for analysis. Descriptive information about the variables used to address question 1 can be found in Table 1 (below).

```{r table_one, echo=FALSE, results="asis", header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
df_life_expectancy_14_subset <- subset(df_life_expectancy_2014,select = c(Status, Population, Life.expectancy, percentage.expenditure, Measles, Polio, HIV.AIDS, GDP, Schooling, Income.composition.of.resources, BMI, Total.expenditure))# select variables
stargazer(df_life_expectancy_14_subset,type = "latex", no.space = TRUE,
          report = ('vcsp*'), single.row = TRUE, header = FALSE,
          column.sep.width = "0.2pt",
          font.size = "small",
          title="Summary of Variables")
```

Almost all the data have significant differences between the minimum and maximum values, suggesting that the country measurements are spread across a wide range. The population, GDP, and Measles all have large standard deviations, and the mean is exceptionally close to the maximum, which may indicate skewed data. As we prepare for model fitting and assessment, these observations are essential to keep in mind. This is our data ready for model selection.

# Results

## Question 1 (Prediction)

### Results

We then proceeded to model fitting. To answer the first research question, we fit a simple linear regression model with life expectancy as our response variable. We fit three models to study the relationship between the independent variables and life expectancy, including only our *a priori* variables, using backward stepwise selection and our final model which combines our *a priori* variables with the result of the backward stepwise selection. During this process, we found that the Income composition of resources variable was in fact analogous to human development index. We chose not to include it in our model for two reasons:

- Human development index is a measure that already factors life expectancy, our response variable.

- We suspected that it had a high correlation with the development status of a country. To test this, we fit a logistic regression model with status and income composition of resources. After we found that there was indeed a correlation, we excluded income composition of resources from our list of *a priori* variables and instead included the development status of a country and the average years of schooling of the population. 

To find the best fit parsimonious model, we evaluated the models using adjusted R^2 and BIC.

Finally, we obtain diagnostic information about the performance of our models.

```{r model1, echo=FALSE, results="asis", message=FALSE, warning=FALSE}
# model with a priori variables
# HIV, Income composition of resources, Total expenditure
mlrmod <- lm(Life.expectancy ~ Status + pop + Schooling + Measles + Polio + HIV.AIDS + GDP + BMI + Total.expenditure, data = df_2014_cleaned)
# summary(mlrmod)

# Adult mortality, total expenditure, HIV, Income composition of resources
full_model <- lm(Life.expectancy ~ ., data = subset(df_2014_cleaned, select = -c(Status_num,Country, Year,Population)))
# Same as above
m <- step(full_model, trace=FALSE, direction = 'backward')
# summary(m)

mylogit <- glm(Status ~ Income.composition.of.resources, data=df_2014_cleaned, family = "binomial")

# Adult mortality, total expenditure, HIV, Schooling, BMI
final_model <- lm(Life.expectancy ~ Status + Schooling + HIV.AIDS + pop + Measles + Polio + GDP + BMI +  Total.expenditure + Adult.Mortality, data = df_2014_cleaned)

models <- list(full_model,mlrmod, m, final_model)
mod.names <- c('full_model','apriori', 'backwardstepwise', 'final_model')
# TODO: Put bic values in a table
bictab(cand.set = models, modnames = mod.names)

# TODO: Add results model
stargazer(full_model,mlrmod,m,final_model,
          dep.var.labels="Life expectancy",
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          report = ('vcsp*'),
          column.sep.width = "0.2pt",
          digits = 2,
          digits.extra=7,
          font.size = "small",
          covariate.labels=c("Status Developing countries","Adult Mortality num per 1000 people", "infant.deaths per 1000 people", "Alcohol consumption ","Gov. Expenditure on Healthcare", "Hepatitis immunization","Measles recorded per 1000 people","BMI","under.five.deaths","Polio","Total.expenditure","Diphtheria","HIV/AIDS Deaths/1000 live births", "GDP per capita","thinness..1.19.years","thinness.5.9.years","Std. Income Composition of Resources","Years of Schooling","Population"),
          type='latex')
```

```{r model1_backward, echo=FALSE, message=FALSE, warning=FALSE}
regfit.best <- regsubsets(Life.expectancy ~ ., data = subset(df_2014_cleaned, select = -c(Country, Year)), nvmax = 16)
reg.summary <- summary(regfit.best)
# adjusted-R^2 with its largest value
# plot(reg.summary$adjr2,xlab="Number of Variables",ylab="Adjusted Rsq",type="l")
# which.max(reg.summary$adjr2)
# points(15,reg.summary$adjr2[15], col="red",cex=2,pch=20)

# BIC with its smallest value
# plot(reg.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
# which.min(reg.summary$bic)
# points(12,reg.summary$bic[12],col="red",cex=2,pch=20)

# backward stepwise
# regfit.bwd <- regsubsets(Life.expectancy~.,data=subset(df_life_expectancy_cc_2014, select = -c(Country, Year)),nvmax=16,method="backward")
# bwd.summary <- summary(regfit.bwd)
# 
# # bwd.summary
# plot(bwd.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
# which.min(bwd.summary$bic)
# points(12,bwd.summary$bic[12],col="red",cex=2,pch=20)
```

### Model Assessment

Even though using only the model given by backward stepwise selection gives us a model with higher adjusted R^2 and a lower BIC value, we will choose the model that combines this result with our *a priori* variables to study their relationship with the response variable. To check if our final model follows the linear regression assumptions, we will plot the model summary plots. The resulting plots are available in Appendix C.

The linearity assumptions are met throughout the model. We can note that all linear regression assumptions are roughly satisfied.

* Residuals and Fitted Plot: There is no pattern in the residual plot. We can assume a linear relationship between the predictors and the outcome variables. (Linearity assumption)
* Scale-Location Plot: The residuals are equally distributed over the range of predictors. (Homogeneity assumption)
* Normal Q-Q Plot: All points are distributed along the reference line; again, it is good to assume that the data have the normality of the residuals. (Normality of residuals assumption)
* Relationship between residuals and leverage: Any point at 0.5 kitchen distance from the boundary is influential. However, there is no significant point here. (Linearity assumption)

### Model Interpretation [This is not consistent with the brief]

The variables that have a crucial impact on population longevity are 

* HIV/AIDS deaths among children.
* Average body mass index (BMI).
* Government expenditure on healthcare (% total expenditure).
* Average years of schooling.
* The probability of dying between the ages of 15 and 60 per 1000 people.

We observe from our Adjusted R-squared value 0.8194 that 82% of the variance in life expectancy is explained by the model. 

According to the statistics, for the residual summary statistics, and we can see that
the median should be close to 0, i.e., the mean of the residuals. 3Q and 1Q should be quantitatively close
to each other and symmetrically distributed, and the errors follow a Gaussian distribution. Based on the relationship between p value and 0.05 we can conclude that the above five important factors have an impact on life expectancy.If all other variables are held constant，Adults death  probability increase per 0.1% will decrease Life expectancy by 0.03 year (11 days).General government expenditure on health
Rise per 1% will increase Life expectancy by 0.03 year (11 days).HIV.aids death rates (which are kids from 0-4 yrs) Rise 0.1% 
will decrese Life expectancyby 1.04 year (380 days). Everage BMI Increase one unit can increase Life expectancy by 0.04 year (  17 days).
Year of Schooling Rise per year will increase Life expectancy for 1.18 year ( 431 days).We also observe from our Adjusted R-squared value 0.8194 that 82% of the variance in life expectancy is explained by the model.

## Question 2: (Inference)

### Results

Table XXXX: Logistic Regression Models (below) shows the output of 8 predictor variables regressed onto country development status in four models. From left to right, those models are: 

1. the initial full model

2. a model with Health Expenditure/GDP per capita dropped for multicollinearity concerns

3. the potential model fit after all logistic transformations with Income Composition of Resources included

4. the final model fit after dropping the Income Composition of Resources

From the model output, we observe that only one predictor variable has a p-value less than 0.05 denoting it as a significant predictor: *Years of Schooling*. The interpretation of this predictor's coefficient in terms of the odds of a country being identified or labeled as a developed country is: while holding all other predictor variables constant, a one-year increase in *Years of Schooling* make it 2.39 ($e^{1.05}$) times more likely that country being identified as a developed country.

```{r logistic, results="asis", out.width="90%", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE}
le14_fit_full <- glm(Status_num ~ Life.expectancy + percentage.expenditure + BMI + Total.expenditure + HIV.AIDS + GDP + Income.composition.of.resources + log(pop)   + Schooling, data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_semi_final <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + GDP + Income.composition.of.resources + log(pop)   + Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_hdi <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + log(GDP) + Income.composition.of.resources + log(pop)   + Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_final <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + log(GDP) + log(pop)   + Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_final_1 <- glm(Status_num ~ Life.expectancy  + BMI + Total.expenditure + HIV.AIDS + log(GDP) + log(pop)   + Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

le14_fit_one <- glm(Status_num ~ Schooling , data = df_2014_cleaned, family=binomial(link="logit"))

# stargazer(le14_fit_full,le14_fit_semi_final, le14_fit_hdi, le14_fit_final,
stargazer(le14_fit_full,le14_fit_semi_final, le14_fit_hdi, le14_fit_final,
          dep.var.labels="Development Status",
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          report = ('vcsp*'),
          column.sep.width = "0.1pt",
          digits = 2,
          digits.extra=7,
          font.size = "small",
          title='Logistic Regression Models',
          covariate.labels=c("Life Expectancy","Health Expend. /GDP per capita", "BMI", "Gov. Expend. on Healthcare", "HIV/AIDS Deaths/1k live births", "GDP per capita","Log of GDP per capita", "Std. Income Composit. of Resources", "Log of Population","Years of Schooling"),
          type='latex')

```

We also examine multicollinearity concerns for all four model fits. The table below clearly shows that the first model has significant problems, with two variables scoring a VIF of over 10. After we remove one variable, all subsequent models are satisfactory, with no variables scoring high on this test.

```{r multicol test, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
vif_table_full <- vif(le14_fit_full)
vif_table_semi_final <- vif(le14_fit_semi_final)
vif_table_hdi <- vif(le14_fit_hdi)
vif_table_final <- vif(le14_fit_final)
vif_table_summary <- dplyr::bind_rows(vif_table_full, vif_table_semi_final,vif_table_hdi, vif_table_final)
colnames(vif_table_summary) <- c("Life Expectancy","Health Expenditure/GDP per capita", "BMI", "Health Gov. Expenditure Percentage", "HIV/AIDS Deaths/1000 live births", "GDP per capita","Std. Income composition of resources", "Log of Population" , "Years of Schooling", "Log of GDP per capita")
rownames(vif_table_summary) <- c("(1)", "(2)", "(3)", "(4)")
stargazer(vif_table_summary,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Variance Inflation Factors',
          flip=TRUE,
          type='latex'
          )

```

### Assessment

Before assessing the accuracy of the potential model fit (3rd model) for this research question, we realize the interpretation of *Income Composition of Resources* variable might be troublesome. It was recorded as Human Development Index in terms of income composition of resources (index ranging from 0 to 1); however, its meaning could be more transparent. We decided to adjust the model to omit *Income Composition of Resources* variable and try to predict the development status of each country in the dataset. Those predictions are used to build a confusion matrix, shown in the table below. From this table, we can determine the True Positive, True Negative, False Negative, and False Positive rates by comparing predicted and actual values. For prediction, we first use the threshold of 0.5 to classify countries as developed or developing. The accuracy of this model is approximately 91\%, with a 95% Confidence Interval of within 83% ~ 95%.

```{r ConfMat, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
conf_mat <- confusionMatrix(as.factor(ifelse(fitted(le14_fit_final)>=0.5, "Developed", "Developing")), df_2014_cleaned$Status, positive = "Developed" )
# conf_mat
conf_mat_t <- matrix(c(11,5,8,105), ncol=2, byrow=TRUE)
colnames(conf_mat_t) <- c("True Developed","True Developing")
rownames(conf_mat_t) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_t,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix for Final Model",
          type='latex')
```

```{r binplot, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
# binnedplot(fitted(le14_fit_final),residuals(le14_fit_final,"resp"),xlab="Pred. probabilities",col.int="red4",
#            ylab="Avg. residuals",main="Binned residual plot",col.pts="navy")
```

A valuable tool for measuring our predictions is the Receiver Operator Characteristic (ROC) curve with the axis as true positive rate (Sensitivity) and true negative rate (1 - Specificity). We find out the optimal prediction cut-off for the year 2014 dataset is 0.232, and we can see that the area under the curve is 0.959, a very strong number. We leave the value as described because the small number of countries designated as developing in our dataset means that each missed prediction carries greater weight in this group. We observed five false positives and eight false negatives in our matrix and are satisfied with this result. 

```{r ROCFinal, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
# invisible(roc(df_2014_cleaned$Status_num,fitted(le14_fit_final),plot=T,print.thres=0.5,legacy.axes=T,
              # print.auc =T,col="red3"))
invisible(roc(df_2014_cleaned$Status_num,fitted(le14_fit_final),plot=T,print.thres="best",legacy.axes=T,
              print.auc =T,col="red3"))
```


### Out-of-Sample Predictions

A final validation step for this model was to predict out-of-sample probabilities for the Year 2013 dataset using the "optimal" threshold, 0.232, as mentioned above, for inferring developed or developing status. The result of this experiment is shown in the table below. The accuracy of these predictions is still 0.91, with a 95% Confidence Interval of being within the range of 84 ~ 95%, which is approximately the same accuracy as our training dataset and should be considered a good fit.


```{r ConfMat_infer, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
df_2013_cleaned$pred<- predict(le14_fit_final, df_2013_cleaned, type="response")
conf_mat_pred <- confusionMatrix(as.factor(ifelse(df_2013_cleaned$pred>=0.232, "Developed", "Developing")), df_2013_cleaned$Status, positive = "Developed" )
# conf_mat_pred
conf_mat_pred_t <- matrix(c(16,9,3,100),ncol=2, byrow=TRUE)
colnames(conf_mat_pred_t) <- c("True Developed","True Developing")
rownames(conf_mat_pred_t) <- c("Predicted Developed","Predicted Developing")
stargazer(conf_mat_pred_t,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title="Confusion Matrix for Inferring Year 2013 Data",
          type='latex')
```

```{r predpro, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="100%", fig.align='center', echo=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
ggplot(df_2013_cleaned,aes(x=Schooling, y=pred), group = Status)+
  geom_point(alpha = 0.7, aes(colour=Status))+
  geom_smooth(col="red3")+ theme_classic()+
  geom_linerange(aes(x=NULL, y=0.232, xmin=5, xmax=15), linetype="dotted")+
  # geom_hline(yintercept=0.232, linetype="dashed")+
  geom_linerange(aes(x=15, y=NULL, ymin=-0.2, ymax=0.232), linetype="dotted")+
  # geom_vline(xintercept=15, linetype="dotted")+
  annotate("text", x = 9, y = 0.28, label = "Best Threshold at 0.232", vjust = -0.5)+
  # ylim(0,1.5)+
  labs(title="Pred. Prob. of Identified as Developed vs Schooling", x= "Avg. Years of Scooling", y ="Pred. Prob. of being Developed Country")
```

As you can see from the plot above, keeping all the other variables constant, if a given country has a population averaging over 15 years of schooling, we may infer that the country would be more likely identified as a developed country than a developing one. On the other hand, if a country with people's average years of schooling is lower than 15 years, according to our model, we shall infer the country is a developing country.


```{r box, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="100%", fig.align='center', echo=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
ggplot(df_2013_cleaned,aes(x=Status, y=Schooling, color=Status))+
  geom_boxplot()+theme_classic()+
  labs(title="Schooling vs Country Status Boxplot", x= "Country Status", y ="Avg. Years of Scooling")
```

```{r ROCPred,include=FALSE, results="asis", fig.width=5, fig.height=3, fig.show='hold', out.width="75%", fig.align='center', echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=FALSE, eval=FALSE}

# Cut to save space

#Receiver Operator Characteristic (ROC) curve (Sensitivity vs 1 - Specificity) is shown below, and the Area Under the Curve (AUC) is 0.966. The fact that AUC is so close to 1 confirms that this model does a good job identifying country development status for another year, 2013.


invisible(roc(df_2013_cleaned$Status_num,df_2013_cleaned$pred,plot=T,print.thres=0.232,legacy.axes=T,
              print.auc =T,col="red3"))


```

### Final Model Evaluation

We compare the final model with a model with only one predictor variable, *Years of Schooling*. An ANOVA result surprisingly shows that the two models are not statistically different in terms of "inference" accuracy. As we can see in the table below (Analysis of Deviance: Final Model vs. Model w/ One Predictor Variable), the p-value of 0.07 is greater than 0.05, meaning the *Years of Schooling* variable on its own is an excellent indicator of whether the country should be considered as developed or developing country.

```{r ANOVA, results="asis", echo=FALSE, header=FALSE, message=FALSE, warning=FALSE,cache=FALSE}
anova_t <- anova(le14_fit_final, le14_fit_one, test="Chisq")
stargazer(anova_t,
          summary=FALSE,
          header=FALSE,
          no.space = TRUE,
          single.row = TRUE,
          column.sep.width = "0.2pt",
          digits = 2,
          font.size = "small",
          title='Analysis of Deviance: Final Model vs Model w/ One Predictor Variable',
          type='latex')
```

# Conclusion

This analysis is concluded with several important takeaways and policy considerations for nations seeking to improve either life expectancy or development status. 

## Limitations

It is essential to disclose limitations and lessons learned to the data scientists and others attempting a similar analysis. First, the team found significant challenges with portions of the dataset, as mentioned in multiple report sections. We mitigated those challenges to the best of our ability. However, it is still worth calling out the importance of understanding the chain of custody, beginning with data collection until it is analyzed. In this case, countries of origin collected data, which the WHO compiled, then recompiled by researchers before it reached the team. None of these actors have malice in their data practice, but mistakes do happen.

More delicately, there is also a consideration of the geopolitical nature of this type of analysis. The status of a region and its people can be difficult, and several unresolved situations worldwide can challenge analysts. We take the region of Kosovo as an example. Depending on your background, Kosovo may be a country, breakaway region, province of Serbia, or something else altogether. We do not seek to arbitrate these discussions but rather point out their impact on whether we count data once, twice, or not at all in a study such as this one.

## Areas for Future Study

We identified several areas in the course of the study that are deserving of more analytical attention. These areas might have been outside the scope of our analysis or required time the team did not have available. They are:

* The interaction between Development Status and HIV when analyzing Life Expectancy: We expect better medical care in developed countries contributes to higher life expectancy.

* The interaction between Development Status and Schooling when analyzing Life Expectancy: We expect more schooling may not affect life expectancy for developed countries

* The region or continent of the countries included in the study. This element was not included in our analysis but did appear interesting when the data were visualized on a map. The causality of this relationship is intriguing.

* Changes in our outcome categories over time. As an example, global Human Development Index figures are going up consistently, but there are still a lot of developing countries

## Recommendations

For policymakers looking to improve average life expectancy, we confidently recommend prioritizing schooling, investing in healthcare, and taking population health measures as more deserving of attention. These areas should not be surprising against a common sense check, but the importance of schooling in our results is worth emphasizing repeatedly. The impact of education on development status is again noteworthy. We would make policy recommendations that encourage investment in this area to drive improvements in societal well-being. Schooling does present a dilemma, as the investment in upskilling the younger portion of a population requires withholding them from the workforce, potentially in situations where they offer crucial labor. Nonetheless, the benefits clearly outweigh the short-term economic costs, and we encourage countries to consider this approach.

\newpage
# Appendix
**Appendix A - Variable Descriptions**

| Variable                        |  Type   |                                                                                            Description |
|-------------------------|:----------------:|-----------------------------:|
| Country                         | factor  |                                                                                           Country name |
| Year                            | numeric |                                                                                       Year of the data |
| Status                          | factor  |                                                              Country status of developed or developing |
| Life_Expectancy                 | numeric |                                                                                 Life expectancy in age |
| Adult_Mortality                 | numeric | Adult Mortality Rates of both sexes (probability of dying between 15 and 60 years per 1000 population) |
| infant.deaths                   | numeric |                                                            Number of Infant Deaths per 1000 population |
| Alcohol                         | numeric |                             Alcohol, recorded per capita (15+) consumption (in litres of pure alcohol) |
| percentage.expenditure          | numeric |                          Expenditure on health as a percentage of Gross Domestic Product per capita(%) |
| Hepatitis.B                     | numeric |                                         Hepatitis B (HepB) immunization coverage among 1-year-olds (%) |
| Measles                         | numeric |                                                           number of reported cases per 1000 population |
| BMI                             | numeric |                                                           Average Body Mass Index of entire population |
| under.five.deaths               | numeric |                                                        Number of under-five deaths per 1000 population |
| Polio                           | numeric |                                               Polio (Pol3) immunization coverage among 1-year-olds (%) |
| Total.expenditure               | numeric |           General government expenditure on health as a percentage of total government expenditure (%) |
| Diphtheria                      | numeric |             Diphtheria tetanus toxoid and pertussis (DTP3) immunization coverage among 1-year-olds (%) |
| HIV.AIDS                        | numeric |                                                      Deaths per 1 000 live births HIV/AIDS (0-4 years) |
| GDP                             | numeric |                                                             Gross Domestic Product per capita (in USD) |
| Population                      | numeric |                                                                              Population of the country |
| thinness..1.19.years            | numeric |                            Prevalence of thinness among children and adolescents for Age 10 to 19 (% ) |
| thinness.5.9.years              | numeric |                                                Prevalence of thinness among children for Age 5 to 9(%) |
| Income.composition.of.resources | numeric |        Human Development Index in terms of income composition of resources (index ranging from 0 to 1) |
| Schooling                       | numeric |                                                                    Number of years of Schooling(years) |

\newpage

**Appendix B - EDA Plots**

```{r eda1, echo=FALSE, results="asis", message=FALSE, warning=FALSE}
# scatterplot matrix
# ggpairs(subset(df_life_expectancy_cc_2014, select = c(Life.expectancy, GDP, Population, percentage.expenditure, Hepatitis.B, Measles, Polio, HIV.AIDS, Diphtheria, Schooling, Income.composition.of.resources)))

# boxplot matrix
life_expectancy_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Life.expectancy, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
gdp_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=GDP, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")

population_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Population, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
percentage_expenditure_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=percentage.expenditure, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
hepatitis_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Hepatitis.B, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
measles_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Measles, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
polio_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Polio, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
hiv_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=HIV.AIDS, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
diphtheria_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Diphtheria, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
schooling_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Schooling, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
income_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Income.composition.of.resources, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")


#gender_plot <- ggplot(airline,aes(Gender, Age))+geom_boxplot(aes(fill=Satisfaction))
plot_grid(life_expectancy_plot, gdp_plot, population_plot, percentage_expenditure_plot, hepatitis_plot, measles_plot, polio_plot, hiv_plot, diphtheria_plot, schooling_plot, income_plot, ncol=3)
```

\newpage

**Appendix C - Residual Plots, Question 1**

```{r model_assessment, echo=FALSE, message=FALSE, warning=FALSE}
par(mfrow = c(2,2))
plot(final_model)
```
\newpage

[Presently, a dumping ground for all our images and lots until we know what we want to keep]

```{r eda, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
library(GGally)

# scatterplot matrix
ggpairs(subset(df_life_expectancy_cc_2014, select = c(Life.expectancy, GDP, Population, percentage.expenditure, Hepatitis.B, Measles, Polio, HIV.AIDS, Diphtheria, Schooling, Income.composition.of.resources)))
```

```{r eda_boxplots, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# boxplot matrix
life_expectancy_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Life.expectancy, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
gdp_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=GDP, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")

population_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Population, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
percentage_expenditure_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=percentage.expenditure, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
hepatitis_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Hepatitis.B, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
measles_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Measles, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
polio_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Polio, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
hiv_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=HIV.AIDS, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
diphtheria_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Diphtheria, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
schooling_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Schooling, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")
income_plot <- ggplot(df_life_expectancy_cc_2014, aes(y=Income.composition.of.resources, x=Status, fill=Status)) + 
    geom_boxplot() + theme(axis.text=element_text(size=8),
    axis.title=element_text(size=8,face="bold"), legend.position = "none")


#gender_plot <- ggplot(airline,aes(Gender, Age))+geom_boxplot(aes(fill=Satisfaction))
plot_grid(life_expectancy_plot, gdp_plot, population_plot, percentage_expenditure_plot, hepatitis_plot, measles_plot, polio_plot, hiv_plot, diphtheria_plot, schooling_plot, income_plot, ncol=3)
```


\newpage
# References
